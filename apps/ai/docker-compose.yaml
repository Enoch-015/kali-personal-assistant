services:
  # ------------------------
  # Redis (L1 / L2 Cache)
  # ------------------------
  redis:
    image: redis:7.2-alpine
    container_name: kali-redis
    command: >
      redis-server
      --appendonly yes
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --save 60 1
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ------------------------
  # Neo4j (Graphiti)
  # ------------------------
  neo4j:
    image: neo4j:5.26
    container_name: kali-neo4j
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4J_dbms_memory_pagecache_size: 2G
      NEO4J_dbms_memory_heap_initial__size: 1G
      NEO4J_dbms_memory_heap_max__size: 2G
      NEO4J_PLUGINS: '["apoc"]'
    ports:
      - "7474:7474"   # Browser
      - "7687:7687"   # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/import
      - neo4j_plugins:/plugins
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "password", "RETURN 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ------------------------
  # MongoDB (Sessions / Transcripts / Patterns)
  # ------------------------
  mongodb:
    image: mongo:7.0
    container_name: kali-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: kali
      MONGO_INITDB_ROOT_PASSWORD: kalipassword
    volumes:
      - mongo_data:/data/db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 10s
      timeout: 10s
      retries: 5

  # ------------------------
  # (Optional) Redis Insight
  # ------------------------
  redis-insight:
    image: redis/redisinsight:latest
    container_name: kali-redis-insight
    ports:
      - "8001:8001"
    restart: unless-stopped
    depends_on:
      - redis

  # ------------------------
  # LiveKit Server (Dev Mode)
  # ------------------------
  livekit:
    image: livekit/livekit-server
    container_name: kali-livekit
    environment:
      # API key:secret format MUST include space after colon
      LIVEKIT_KEYS: "devkey: secret"
    ports:
      - "7880:7880"   # Signaling / WebSocket
      - "7881:7881"   # TCP fallback
      - "50000-50100:50000-50100/udp"  # WebRTC media
    restart: unless-stopped
    command: --dev
    depends_on:
      - redis  # optional if you want caching

# ------------------------
# Named Volumes
# ------------------------
volumes:
  redis_data:
  neo4j_data:
  neo4j_logs:
  neo4j_import:
  neo4j_plugins:
  mongo_data:
